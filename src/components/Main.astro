---
import { Image } from "astro:assets";

import Body from "./Body.astro";
import Circles from "./Circles.svelte";
import Container from "./Container.astro";
import ThemeSwitcher from "./ThemeSwitcher.astro";

import favicon from "@public/favicon.png";

const animDuration = "0.4s";

const anim = {
  old: {
    name: "blur-out",
    duration: animDuration,
  },
  new: {
    name: "blur-in",
    duration: animDuration,
  },
};

const customTransition = {
  forwards: anim,
  backwards: anim,
};

const { isPost } = Astro.props;

const mainPad = "md:px-12 sm:px-8 px-6";
---

<style>
  .masky {
    mask-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0.9),
      rgba(0, 0, 0, 0.7)
    );
    mask-repeat: no-repeat;
    mask-size: cover;
  }
</style>

<Body>
  {!isPost && <Circles client:load />}

  <header
    class="sticky top-0
    z-50
    backdrop-blur-md
    backdrop-brightness-80
    border-b-1 border-black/20 dark:border-white/20"
  >
    <div class=`${mainPad} py-4`>
      <a href="/" class="flex items-center gap-2 no-underline masky">
        <Image src={favicon} alt="favicon" height="16" />
        <span>tekno world</span>
      </a>
    </div>
  </header>

  <main
    class={`prose dark:prose-invert ${mainPad} py-8
    mx-auto
    ${
      isPost
        ? "w-[min(100%,70ch)]! max-w-[70ch]!"
        : "w-[min(100%,65ch)]! max-w-[65ch]!" /* 65ch is prose default */
    }`}
    transition:animate={customTransition}
  >
    <slot />

    <hr />

    <div class="flex justify-between gap-3">
      <a href="https://github.com/f0e/site">site source code</a>
      <ThemeSwitcher />
    </div>
  </main>
</Body>

<style>
  :root {
    --anim-distance: 20px;
    --blur-amount: 8px;
  }

  @keyframes blur-in {
    from {
      opacity: 0;
      filter: blur(var(--blur-amount));
    }
  }

  @keyframes blur-out {
    to {
      opacity: 0;
      filter: blur(var(--blur-amount));
    }
  }
</style>

<script is:inline>
  // @TODO: is there a better, more natively Astro way of doing this?

  const images = document.querySelectorAll(".fade-in");

  images.forEach((img) => {
    if (!img.complete || img.naturalWidth === 0) {
      // not already loaded, fade in
      img.classList.add("opacity-0");

      img.addEventListener("load", () => {
        img.classList.add("transition-opacity", "duration-300");
        img.classList.remove("opacity-0");
      });
    }
  });
</script>
