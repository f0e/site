<div id="comments"></div>

<script is:inline>
  // Function to get the current theme from the site
  function getCurrentTheme() {
    return globalThis.ThemeProvider.isDarkTheme() ? "dark" : "light";
  }

  // Function to update Giscus theme
  function updateGiscusTheme(theme) {
    const iframe = document.querySelector("iframe.giscus-frame");
    if (iframe?.contentWindow) {
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme: theme } } },
        "https://giscus.app"
      );
    }
  }

  // Set initial theme when Giscus loads
  function handleGiscusLoad() {
    const currentTheme = getCurrentTheme();
    updateGiscusTheme(currentTheme);
  }

  // Listen for the site's theme change events
  document.addEventListener("theme-change", (event) => {
    updateGiscusTheme(event.detail.theme);
  });

  // Listen for Giscus ready event to set initial theme
  window.addEventListener("message", (event) => {
    if (event.origin !== "https://giscus.app") return;
    if (!(typeof event.data === "object" && event.data.giscus)) return;

    // When Giscus is ready, set the correct theme
    if (event.data.giscus.discussion) {
      handleGiscusLoad();
    }
  });

  // Also set theme on page load in case Giscus loads before our script
  document.addEventListener("DOMContentLoaded", () => {
    // Wait a bit for Giscus to fully load
    setTimeout(handleGiscusLoad, 1000);
  });

  function initialise() {
    const container = document.querySelector("#comments");
    if (!container) return;

    container.innerHTML = "";

    const giscusAttributes = {
      src: "https://giscus.app/client.js",
      "data-repo": "f0e/site",
      "data-repo-id": "MDEwOlJlcG9zaXRvcnkzOTQ0MDQzMjE=",
      "data-category": "posts",
      "data-category-id": "DIC_kwDOF4Ih4c4C0R5y",
      "data-mapping": "og:title",
      "data-strict": "0",
      "data-reactions-enabled": "0",
      "data-emit-metadata": "0",
      "data-input-position": "top",
      "data-theme": getCurrentTheme(),
      "data-lang": "en",
      crossorigin: "anonymous",
    };

    const giscusScript = document.createElement("script");
    for (const [key, value] of Object.entries(giscusAttributes))
      giscusScript.setAttribute(key, value);
    giscusScript.async = true;

    container.append(giscusScript);
  }

  initialise();

  document.addEventListener("astro:after-swap", () => {
    initialise();
  });
</script>
